export function generateSetupScript(projectName: string): string {
	return `#!/usr/bin/env bash
set -e

# =============================================================================
# Project Setup Script
# Generated by Hatch CLI
# =============================================================================

# Colors for output
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
BLUE='\\033[0;34m'
NC='\\033[0m' # No Color

# Project configuration (embedded at generation time)
PROJECT_NAME="${projectName}"

# State tracking file for idempotency
STATE_FILE=".setup-state"

# =============================================================================
# Helper Functions
# =============================================================================

print_header() {
  echo ""
  echo "========================================"
  echo -e "\${BLUE}\$1\${NC}"
  echo "========================================"
  echo ""
}

print_step() {
  echo -e "\${BLUE}→\${NC} \$1"
}

print_success() {
  echo -e "\${GREEN}✓\${NC} \$1"
}

print_warning() {
  echo -e "\${YELLOW}⚠\${NC} \$1"
}

print_error() {
  echo -e "\${RED}✗\${NC} \$1"
}

# State management for idempotency
mark_completed() {
  echo "\$1" >> "\$STATE_FILE"
}

is_completed() {
  [[ -f "\$STATE_FILE" ]] && grep -q "^\$1$" "\$STATE_FILE"
}

# =============================================================================
# Step 1: Check Prerequisites
# =============================================================================

check_prerequisites() {
  print_header "Checking Prerequisites"

  local missing=()

  # Check gh CLI
  if command -v gh &> /dev/null; then
    print_success "GitHub CLI (gh) installed"
  else
    missing+=("gh")
    print_error "GitHub CLI (gh) not installed"
  fi

  # Check vercel CLI
  if command -v vercel &> /dev/null; then
    print_success "Vercel CLI installed"
  else
    missing+=("vercel")
    print_error "Vercel CLI not installed"
  fi

  # Check jq (needed for parsing JSON)
  if command -v jq &> /dev/null; then
    print_success "jq installed"
  else
    missing+=("jq")
    print_error "jq not installed"
  fi

  if [[ \${#missing[@]} -gt 0 ]]; then
    echo ""
    print_error "Missing required tools: \${missing[*]}"
    echo ""
    echo "Install them with:"
    for tool in "\${missing[@]}"; do
      case \$tool in
        gh)
          echo "  brew install gh"
          ;;
        vercel)
          echo "  npm i -g vercel"
          ;;
        jq)
          echo "  brew install jq"
          ;;
      esac
    done
    exit 1
  fi

  print_success "All prerequisites satisfied"
}

# =============================================================================
# Step 2: Authenticate with GitHub
# =============================================================================

auth_github() {
  print_header "GitHub Authentication"

  # Check if already authenticated
  if gh auth status &> /dev/null; then
    print_success "Already authenticated with GitHub"
    return 0
  fi

  print_step "Opening browser for GitHub authentication..."
  gh auth login --web

  if gh auth status &> /dev/null; then
    print_success "GitHub authentication successful"
  else
    print_error "GitHub authentication failed"
    exit 1
  fi
}

# =============================================================================
# Step 3: Authenticate with Vercel
# =============================================================================

auth_vercel() {
  print_header "Vercel Authentication"

  # Check if already authenticated
  if vercel whoami &> /dev/null 2>&1; then
    print_success "Already authenticated with Vercel"
    return 0
  fi

  print_step "Opening browser for Vercel authentication..."
  vercel login

  if vercel whoami &> /dev/null 2>&1; then
    print_success "Vercel authentication successful"
  else
    print_error "Vercel authentication failed"
    exit 1
  fi
}

# =============================================================================
# Step 3b: Select Vercel Team/Account
# =============================================================================

select_vercel_team() {
  print_header "Vercel Team Selection"

  print_step "Select which Vercel account/team to use for this project..."
  echo ""

  # vercel switch without arguments shows interactive picker
  vercel switch

  # Show which team was selected
  local current_team=\$(vercel whoami 2>/dev/null)
  if [[ -n "\$current_team" ]]; then
    print_success "Using Vercel account: \$current_team"
  fi
}

# =============================================================================
# Step 4: Create GitHub Repository
# =============================================================================

create_github_repo() {
  print_header "GitHub Repository Setup"

  # Check if remote 'origin' already exists locally
  if git remote get-url origin &> /dev/null 2>&1; then
    print_success "Git remote 'origin' already configured"
    # Verify we can access the remote
    if git ls-remote origin &> /dev/null 2>&1; then
      print_success "Remote repository accessible"
    else
      print_warning "Remote exists but may not be accessible"
    fi
    return 0
  fi

  if is_completed "github_repo"; then
    print_success "GitHub repository already created (from previous run)"
    return 0
  fi

  # Check if repo already exists on GitHub before creating
  if gh repo view "\$PROJECT_NAME" &> /dev/null 2>&1; then
    print_warning "Repository '\$PROJECT_NAME' already exists on GitHub"
    echo ""
    echo "Options:"
    echo "  1. Link to existing repository (won't push - manual sync required)"
    echo "  2. Use a different name"
    echo "  3. Cancel setup"
    echo ""
    read -p "Choice (1/2/3): " choice

    case \$choice in
      1)
        # Link to existing - DO NOT push (would overwrite remote)
        local gh_user=\$(gh api user -q .login 2>/dev/null)
        git remote add origin "https://github.com/\$gh_user/\$PROJECT_NAME.git"
        print_success "Linked to existing repository"
        print_warning "Code NOT pushed to avoid overwriting. Sync manually if needed."
        mark_completed "github_repo"
        return 0
        ;;
      2)
        read -p "Enter new repository name: " new_name
        print_step "Creating private GitHub repository: \$new_name"
        if gh repo create "\$new_name" --private --source=. --push; then
          print_success "GitHub repository '\$new_name' created and code pushed"
          mark_completed "github_repo"
        else
          print_error "Failed to create repository"
          exit 1
        fi
        return 0
        ;;
      3)
        print_step "Cancelled by user"
        exit 1
        ;;
      *)
        print_error "Invalid choice"
        exit 1
        ;;
    esac
  fi

  # Safe to create - repo doesn't exist
  print_step "Creating private GitHub repository: \$PROJECT_NAME"

  if gh repo create "\$PROJECT_NAME" --private --source=. --push; then
    print_success "GitHub repository created and code pushed"
    mark_completed "github_repo"
  else
    print_error "Failed to create repository"
    echo ""
    echo "This might happen if:"
    echo "  - Repository name is already taken"
    echo "  - You don't have permission to create repos"
    echo ""
    read -p "Would you like to link to an existing repository? (y/N) " link_existing
    if [[ "\$link_existing" == [yY] ]]; then
      read -p "Enter repository (e.g., username/repo): " repo_name
      git remote add origin "https://github.com/\$repo_name.git"
      git push -u origin main 2>/dev/null || git push -u origin master 2>/dev/null || true
      mark_completed "github_repo"
    else
      exit 1
    fi
  fi
}

# =============================================================================
# Step 5: Create/Link Vercel Project
# =============================================================================

setup_vercel() {
  print_header "Vercel Project Setup"

  # Check if already linked (in apps/web where the Next.js app lives)
  if [[ -f "apps/web/.vercel/project.json" ]]; then
    print_success "Already linked to a Vercel project"
    return 0
  fi

  if is_completed "vercel_project"; then
    print_success "Vercel project already configured (from previous run)"
    return 0
  fi

  print_step "Setting up Vercel project..."

  # Run vercel link with project name and --yes to skip prompts
  cd apps/web
  vercel link --project "\$PROJECT_NAME" --yes

  if [[ -f ".vercel/project.json" ]]; then
    print_success "Vercel project linked: \$PROJECT_NAME"

    # Set root directory via Vercel API (CLI doesn't support this)
    local project_id=\$(jq -r '.projectId' .vercel/project.json)
    local vercel_token=""

    # Try to get token from Vercel CLI config
    # macOS stores in Application Support, Linux in .config
    if [[ -f "\$HOME/Library/Application Support/com.vercel.cli/auth.json" ]]; then
      vercel_token=\$(jq -r '.token // empty' "\$HOME/Library/Application Support/com.vercel.cli/auth.json" 2>/dev/null)
    elif [[ -f "\$HOME/.config/com.vercel.cli/auth.json" ]]; then
      vercel_token=\$(jq -r '.token // empty' "\$HOME/.config/com.vercel.cli/auth.json" 2>/dev/null)
    fi

    if [[ -n "\$vercel_token" && -n "\$project_id" ]]; then
      print_step "Setting Vercel root directory to apps/web..."
      if curl -s -X PATCH "https://api.vercel.com/v9/projects/\$project_id" \\
        -H "Authorization: Bearer \$vercel_token" \\
        -H "Content-Type: application/json" \\
        -d '{"rootDirectory": "apps/web"}' > /dev/null; then
        print_success "Root directory configured"
      else
        print_warning "Could not set root directory - set it manually in Vercel dashboard"
      fi
    else
      print_warning "Could not set root directory automatically - set apps/web in Vercel dashboard"
    fi

    # Connect Git repository for automatic deployments
    local git_url=\$(git remote get-url origin 2>/dev/null || echo "")
    if [[ -n "\$git_url" ]]; then
      print_step "Connecting Git repository..."
      if vercel git connect "\$git_url" 2>/dev/null; then
        print_success "Git repository connected"
      else
        print_warning "Could not auto-connect Git - connect manually in Vercel dashboard"
      fi
    fi
    mark_completed "vercel_project"
  else
    print_warning "Vercel project may not be fully configured"
  fi

  cd ../..
}

# =============================================================================
# Step 5b: Configure Auth Secrets
# =============================================================================

setup_auth_secrets() {
  if [[ ! -f "apps/web/.vercel/project.json" ]]; then
    print_warning "Vercel project not linked, skipping auth secret setup"
    return 0
  fi

  setup_better_auth_secrets
}

setup_better_auth_secrets() {
  print_header "Configuring Better Auth Secrets"

  print_step "Generating unique secrets for each environment..."

  local prod_secret=\$(openssl rand -base64 32)
  local preview_secret=\$(openssl rand -base64 32)
  local dev_secret=\$(openssl rand -base64 32)

  # Helper to set env var (removes existing first to avoid --force issues)
  set_vercel_env() {
    local name="\$1"
    local env="\$2"
    local value="\$3"
    local sensitive="\$4"

    # Remove existing var if present (ignore errors)
    vercel env rm "\$name" "\$env" --cwd apps/web --yes 2>/dev/null || true

    # Add the new value
    local flags=""
    if [[ "\$sensitive" == "true" ]]; then
      flags="--sensitive"
    fi
    printf '%s' "\$value" | vercel env add "\$name" "\$env" \$flags --cwd apps/web
  }

  # Add BETTER_AUTH_SECRET to each environment
  print_step "Adding BETTER_AUTH_SECRET to production..."
  if set_vercel_env "BETTER_AUTH_SECRET" "production" "\$prod_secret" "true" 2>/dev/null; then
    print_success "Production BETTER_AUTH_SECRET configured"
  else
    print_warning "Could not set production secret"
  fi

  print_step "Adding BETTER_AUTH_SECRET to preview..."
  if set_vercel_env "BETTER_AUTH_SECRET" "preview" "\$preview_secret" "true" 2>/dev/null; then
    print_success "Preview BETTER_AUTH_SECRET configured"
  else
    print_warning "Could not set preview secret"
  fi

  print_step "Adding BETTER_AUTH_SECRET to development..."
  # Note: Don't use --sensitive for development env vars
  if set_vercel_env "BETTER_AUTH_SECRET" "development" "\$dev_secret" "false" 2>/dev/null; then
    print_success "Development BETTER_AUTH_SECRET configured"
  else
    print_warning "Could not set development secret"
  fi

  # Add BETTER_AUTH_URL for production
  print_step "Adding BETTER_AUTH_URL to production..."
  if set_vercel_env "BETTER_AUTH_URL" "production" "https://\$PROJECT_NAME.vercel.app" "false" 2>/dev/null; then
    print_success "Production BETTER_AUTH_URL configured"
  else
    print_warning "Could not set production BETTER_AUTH_URL"
  fi

  print_step "Adding BETTER_AUTH_URL to development..."
  if set_vercel_env "BETTER_AUTH_URL" "development" "http://localhost:3000" "false" 2>/dev/null; then
    print_success "Development BETTER_AUTH_URL configured"
  else
    print_warning "Could not set development BETTER_AUTH_URL"
  fi

  # Note: NEXT_PUBLIC_APP_URL is handled automatically via VERCEL_PROJECT_PRODUCTION_URL
  # The app's next.config.ts exposes this to client-side code
  # For feature VMs, NEXT_PUBLIC_APP_URL is set in .env.local to the exe.xyz URL

  # Note: Development secrets will be pulled to .env.local by pull_vercel_env()
  print_success "Better Auth secrets configured for all environments!"
}

# =============================================================================
# Step 6: Pull Vercel Environment Variables
# =============================================================================

pull_vercel_env() {
  print_header "Pulling Vercel Environment Variables"

  if [[ ! -f "apps/web/.vercel/project.json" ]]; then
    print_warning "Vercel project not linked, skipping env pull"
    return 0
  fi

  print_step "Pulling environment variables from Vercel..."

  # Pull to apps/web/.env.local (run from apps/web where .vercel config lives)
  cd apps/web
  vercel env pull .env.local --yes 2>/dev/null || true
  cd ../..

  print_success "Environment variables pulled (if any were configured in Vercel)"
}

# =============================================================================
# Step 7: Final Summary
# =============================================================================

print_summary() {
  print_header "Setup Complete!"

  echo "Your project has been configured with:"
  echo ""

  # GitHub status
  if git remote get-url origin &> /dev/null 2>&1; then
    local repo_url=\$(git remote get-url origin)
    echo -e "  \${GREEN}✓\${NC} GitHub: \$repo_url"
  fi

  # Vercel status
  if [[ -f "apps/web/.vercel/project.json" ]]; then
    echo -e "  \${GREEN}✓\${NC} Vercel: Project linked (apps/web)"
  fi

  echo ""
  echo "Next steps:"
  echo ""
  echo "  1. Review apps/web/.env.local and fill in any missing values:"
  echo "     - RESEND_API_KEY (for email authentication)"
  echo "     - NEXT_PUBLIC_POSTHOG_KEY (optional)"
  echo ""
  echo "  2. Start the Convex dev server:"
  echo "     pnpm convex:dev"
  echo ""
  echo "  3. Start development:"
  echo "     pnpm dev"
  echo ""
}

# =============================================================================
# Step 8: Install Claude Code Skills
# =============================================================================

install_skills() {
  print_header "Installing Skills"

  print_step "Installing vercel-react-best-practices skill..."
  if npx -y skills add vercel-labs/agent-skills --skill vercel-react-best-practices --agent claude-code codex -y; then
    print_success "vercel-react-best-practices skill installed"
  else
    print_warning "Could not install vercel-react-best-practices skill"
  fi

  print_step "Installing agent-browser skill..."
  if npx -y skills add vercel-labs/agent-browser --skill agent-browser --agent claude-code codex -y; then
    print_success "agent-browser skill installed"
  else
    print_warning "Could not install agent-browser skill"
  fi
}

# =============================================================================
# Step 9: Commit Setup Changes and Deploy
# =============================================================================

commit_and_deploy() {
  print_header "Deploying to Production"

  # Check if there are any changes to commit (including untracked files)
  if [[ -z \$(git status --porcelain) ]]; then
    print_step "No setup changes to commit"
  else
    print_step "Committing setup changes..."
    git add -A
    git commit -m "chore: configure project setup

- Add Vercel project configuration
- Update .gitignore with Vercel entries
- Configure environment files" 2>/dev/null || true
  fi

  # Check if we need to push
  local unpushed=\$(git log origin/main..HEAD --oneline 2>/dev/null | wc -l | tr -d ' ')

  if [[ "\$unpushed" -gt 0 ]]; then
    echo ""
    read -p "Push to main and trigger production deploy? (Y/n) " do_deploy
    do_deploy=\${do_deploy:-Y}

    if [[ "\$do_deploy" == [yY] ]]; then
      print_step "Pushing to main..."
      if git push origin main; then
        print_success "Pushed to main - deployment triggered!"
      else
        print_warning "Push failed - deploy manually with: git push origin main"
      fi
    else
      print_step "Skipping deploy - deploy later with: git push origin main"
    fi
  else
    print_success "Already up to date with remote"
    echo ""
    echo "  No new commits to push, but you may still want to deploy."
    read -p "Trigger a production deployment via Vercel CLI? (Y/n) " do_cli_deploy
    do_cli_deploy=\${do_cli_deploy:-Y}

    if [[ "\$do_cli_deploy" == [yY] ]]; then
      print_step "Deploying to production..."
      if vercel --prod --yes; then
        print_success "Production deployment complete!"
      else
        print_warning "Deployment failed - try manually with: vercel --prod"
      fi
    else
      print_step "Skipping deploy - deploy later with: vercel --prod"
    fi
  fi
}

# =============================================================================
# Step 10: Apply Branch Protection (auto-harden)
# =============================================================================

harden_branch() {
  print_header "Applying Branch Protection"

  # Check if harness.json exists
  if [[ ! -f "harness.json" ]]; then
    print_warning "No harness.json found, skipping branch protection"
    return 0
  fi

  # Check if hatch CLI is available
  if ! command -v hatch &> /dev/null; then
    print_warning "hatch CLI not found, skipping auto-harden"
    print_step "Run 'hatch harden' manually after installing the CLI"
    return 0
  fi

  print_step "Applying branch protection to main (solo-friendly, admins can bypass)..."
  if hatch harden --branch main 2>/dev/null; then
    print_success "Branch protection applied"
    print_step "Admins can bypass checks (use 'hatch harden --strict' for team mode)"
  else
    print_warning "Could not apply branch protection automatically"
    print_step "Run 'hatch harden' manually to configure branch protection"
  fi
}

# =============================================================================
# Main Execution
# =============================================================================

main() {
  echo ""
  echo "========================================"
  echo "       \$PROJECT_NAME Setup"
  echo "========================================"
  echo ""
  echo "Mode: Convex (serverless backend)"
  echo ""

  check_prerequisites
  auth_github
  auth_vercel
  select_vercel_team
  create_github_repo
  setup_vercel
  setup_auth_secrets
  pull_vercel_env
  install_skills
  commit_and_deploy
  harden_branch
  print_summary
}

# Run main function
main "\$@"
`;
}
